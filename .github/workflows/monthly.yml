name: Delran BOE Preschool Monitor (Monthly)

on:
  schedule:
    # Run at 13:00 UTC on days 28â€“31; job self-skips unless it's the last UTC day of the month.
    - cron: '0 13 28-31 * *'
  workflow_dispatch:
    inputs:
      backfill:
        description: 'Run immediate backfill from 2021-01-01 to today'
        required: false
        default: 'false'
        type: choice
        options: ['false','true']
      ignore_dedupe:
        description: 'Ignore dedupe state and include all matches'
        required: false
        default: 'false'
        type: choice
        options: ['false','true']
      max_boarddocs_files:
        description: 'Max BoardDocs PDFs to process'
        required: false
        default: '50'
        type: string

# One concurrent run per ref; do not cancel an in-flight monthly job
concurrency:
  group: monthly-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write          # to commit .data/seen.json
  id-token: write          # required for OIDC with azure/login

jobs:
  monthly:
    name: Build report, upload to OneDrive, and email results
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine date range
        id: daterange
        shell: bash
        run: |
          set -euo pipefail
          TODAY_UTC="$(date -u +%F)"

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.backfill }}" == "true" ]]; then
            START_DATE="2021-01-01"
            END_DATE="$TODAY_UTC"
            MODE="backfill"
          else
            if [[ "${{ github.event_name }}" == "schedule" ]]; then
              # Only continue on the last UTC day of the month
              if [[ $(date -u -d "$TODAY_UTC + 1 day" +%d) != "01" ]]; then
                echo "Not the last day of month (UTC). Skipping the run."
                echo "skip=true" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
            START_DATE="$(date -u -d "$(date -u +%Y-%m-01)" +%F)"
            END_DATE="$TODAY_UTC"
            MODE="monthly"
          fi

          {
            echo "skip=false"
            echo "start_date=$START_DATE"
            echo "end_date=$END_DATE"
            echo "mode=$MODE"
          } >> "$GITHUB_OUTPUT"

      - name: Set up Python
        if: steps.daterange.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        if: steps.daterange.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f scripts/requirements.txt ]; then
            REQ="scripts/requirements.txt"
          elif [ -f requirements.txt ]; then
            REQ="requirements.txt"
          else
            echo "ERROR: No requirements.txt found at scripts/requirements.txt or requirements.txt"
            exit 1
          fi
          echo "Installing from $REQ"
          pip install -r "$REQ"

      - name: Build monthly report
        if: steps.daterange.outputs.skip != 'true'
        shell: bash
        env:
          START_DATE: ${{ steps.daterange.outputs.start_date }}
          END_DATE: ${{ steps.daterange.outputs.end_date }}
        run: |
          set -euo pipefail
          echo "START_DATE=$START_DATE"
          echo "END_DATE=$END_DATE"

          MIN_YEAR="$(echo "$START_DATE" | cut -c1-4)"
          FILE_LIMIT="${{ inputs.max_boarddocs_files || '50' }}"
          EXTRA=""
          if [[ "${{ inputs.ignore_dedupe }}" == "true" ]]; then
            EXTRA="--ignore-dedupe"
          fi

          echo "Running preschool_monitor.py ..."
          python scripts/preschool_monitor.py \
            --start "$START_DATE" \
            --end "$END_DATE" \
            --out-md report.md \
            --out-html report.html \
            --out-csv report.csv \
            --min-year "$MIN_YEAR" \
            --max-boarddocs-files "$FILE_LIMIT" \
            $EXTRA

          echo "Files after monitor run (repo root):"
          ls -la || true
          echo "---- .data ----"
          ls -la .data || true

      - name: List workspace (after report build)
        if: steps.daterange.outputs.skip != 'true'
        run: |
          echo "PWD=$(pwd)"
          echo "----- repo root -----"
          ls -la
          echo "----- scripts/ -----"
          ls -la scripts || true
          echo "----- .data/ -----"
          ls -la .data || true

      - name: Commit dedupe state
        if: steps.daterange.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain .data/seen.json | grep -q .; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .data/seen.json
            git commit -m "chore: update seen.json for ${{ steps.daterange.outputs.mode }} run (${{ steps.daterange.outputs.start_date }} to ${{ steps.daterange.outputs.end_date }})"
            # Avoid non-fast-forward errors if something changed upstream
            git pull --rebase || true
            git push || true
          else
            echo "No state changes to commit."
          fi

      # ===== OneDrive Upload & Share Link =====
      - name: Azure login (OIDC)
        if: steps.daterange.outputs.skip != 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: Upload reports & attachments to OneDrive and create share link
        if: steps.daterange.outputs.skip != 'true'
        id: onedrive
        uses: azure/cli@v2
        env:
          ONEDRIVE_UPN: 'robwaz@delrankids.net'
          BASE_PATH_HUMAN: 'Ai Agents/delran-preschool-monitor/BOA Files'
        with:
          inlineScript: |
            set -euo pipefail

            TOKEN="$(az account get-access-token --resource-type ms-graph --query accessToken -o tsv)"

            # URL-encode a path but keep folder separators
            ENC_BASE=$(python - <<'PY'
import urllib.parse, sys
print(urllib.parse.quote(sys.argv[1], safe='/-._~'))
PY
"$BASE_PATH_HUMAN")

            Y=$(date -u -d "${{ steps.daterange.outputs.start_date }}" +%Y)
            M=$(date -u -d "${{ steps.daterange.outputs.start_date }}" +%m)
            BASE="https://graph.microsoft.com/v1.0/users/$ONEDRIVE_UPN/drive"

            # Ensure base parent path
            curl -sS -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
              -d '{"name":"'"$(basename "$BASE_PATH_HUMAN")"'","folder":{},"@microsoft.graph.conflictBehavior":"replace"}' \
              "$BASE/root:/${ENC_BASE%/*}:/children" >/dev/null || true

            # Ensure YEAR
            curl -sS -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
              -d '{"name":"'"$Y"'","folder":{},"@microsoft.graph.conflictBehavior":"replace"}' \
              "$BASE/root:/$ENC_BASE:/children" >/dev/null || true

            # Ensure MONTH
            curl -sS -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
              -d '{"name":"'"$M"'","folder":{},"@microsoft.graph.conflictBehavior":"replace"}' \
              "$BASE/root:/$ENC_BASE/$Y:/children" >/dev/null || true

            # Upload core reports
            for f in report.md report.html report.csv; do
              if [ -f "$f" ]; then
                curl -sS -X PUT -H "Authorization: Bearer $TOKEN" --data-binary @"$f" \
                  "$BASE/root:/$ENC_BASE/$Y/$M/$f:/content" >/dev/null
              fi
            done

            # Upload any PDF attachments listed by the monitor
            if [ -f .data/attachments.json ]; then
              python - <<'PY' > _pdfs.txt
import json, os
try:
    paths = json.load(open('.data/attachments.json'))
except Exception:
    paths = []
for p in paths:
    if p and os.path.exists(p) and p.lower().endswith('.pdf'):
        print(p)
PY
              while read -r pdf; do
                [ -n "$pdf" ] || continue
                name=$(basename "$pdf")
                curl -sS -X PUT -H "Authorization: Bearer $TOKEN" --data-binary @"$pdf" \
                  "$BASE/root:/$ENC_BASE/$Y/$M/$name:/content" >/dev/null || true
              done < _pdfs.txt
            fi

            # Create share link for the month folder (organization scope)
            SHARE_JSON=$(curl -sS -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
              -d '{"type":"view","scope":"organization"}' \
              "$BASE/root:/$ENC_BASE/$Y/$M:/createLink")

            LINK=$(python - <<'PY'
import json,sys
try:
  j=json.load(sys.stdin)
  print(j.get('link',{}).get('webUrl',''))
except Exception:
  print('')
PY
<<< "$SHARE_JSON")

            echo "share_url=$LINK" >> "$GITHUB_OUTPUT"

            # Append link to reports if present
            if [ -n "$LINK" ]; then
              {
                echo
                echo "**OneDrive (view) link for this month's folder:**"
                echo "$LINK"
                echo
              } >> report.md

              python - "$LINK" <<'PY'
import sys
link = sys.argv[1]
with open('report.html','r',encoding='utf-8') as f:
    html = f.read()
insertion = f"<p><strong>OneDrive (view) link for this month's folder:</strong> <a href='{link}'>{link}</a></p></body></html>"
html = html.replace('</body></html>', insertion)
with open('report.html','w',encoding='utf-8') as f:
    f.write(html)
PY
            fi

      - name: Email results (with attachments if any)
        if: steps.daterange.outputs.skip != 'true'
        shell: bash
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: 'robwaz@delrankids.net'
          SUBJECT: 'Delran BOE Preschool Mentions (New): ${{ steps.daterange.outputs.start_date }} to ${{ steps.daterange.outputs.end_date }}'
        run: |
          set -euo pipefail
          echo "SMTP_HOST=$SMTP_HOST"
          echo "SMTP_PORT=$SMTP_PORT"
          echo "MAIL_FROM=$MAIL_FROM"
          echo "MAIL_TO=$MAIL_TO"
          echo "Subject=$SUBJECT"

          # Build optional attachment args from .data/attachments.json
          if [ -f .data/attachments.json ]; then
            python - <<'PY' > attach_args.txt
import json, shlex
try:
    paths = json.load(open('.data/attachments.json'))
except Exception:
    paths = []
print(' '.join('--attachment '+shlex.quote(p) for p in paths if p))
PY
          else
            echo "" > attach_args.txt
          fi
          EXTRA_ARGS="$(cat attach_args.txt)"
          echo "EXTRA_ARGS=$EXTRA_ARGS"

          ls -la report.* || true

          # Attempt to send email; if it fails, print exit code
          set +e
          python scripts/send_email.py \
            --subject "$SUBJECT" \
            --html-body report.html \
            --text-body report.md \
            --attachment report.md $EXTRA_ARGS
          RC=$?
          set -e
          echo "send_email.py exit code: $RC"

      - name: Upload reports as artifact (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-reports
          path: |
            report.md
            report.html
            report.csv
            .data/attachments.json
          if-no-files-found: warn
