name: "Delran Preschool Monitor (Monthly)"

on:
  schedule:
    # Runs at 12:00 UTC on days 28-31; a step checks if it's actually the last day
    - cron: "0 12 28-31 * *"
  workflow_dispatch:
    inputs:
      send_test:
        description: "Send a one-time test email first"
        required: false
        type: boolean
        default: false
      override_last_day:
        description: "Run even if today is not the last day (manual runs only)"
        required: false
        type: boolean
        default: false
      force_full_rescan:
        description: "Force a full rescan (ignore state.json) â€” use sparingly"
        required: false
        type: boolean
        default: false
      year:
        description: "Optional: limit to one year (e.g., 2024); blank = normal monthly window"
        required: false
        type: string
        default: ""
      max_boarddocs_files:
        description: "Cap BoardDocs discovery (75 is fine for monthly)"
        required: false
        type: number
        default: 75
      debug_save_html:
        description: "Save fetched HTML in .debug/ (normally OFF for monthly)"
        required: false
        type: boolean
        default: false
      doc_delay_seconds:
        description: "Delay between document fetches"
        required: false
        type: string
        default: "1.5"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Guard: entity-free workflows (self-safe patterns)
      - name: Guard - workflows must not contain HTML entities
        run: |
          set -e
          a='&'; b='lt;';  pat_lt="${a}${b}"
          b='gt;';         pat_gt="${a}${b}"
          b='amp;';        pat_amp="${a}${b}"
          tmp="$(mktemp)"
          (cat .github/workflows/*.yml 2>/dev/null || true) | awk '!/^[[:space:]]*#/' > "$tmp"
          # Debug (optional): uncomment to see exact matches
          # echo "::group::Raw grep output (if any)"; grep -nE "${pat_lt}|${pat_gt}|${pat_amp}" "$tmp" || true; echo "::endgroup::"
          if grep -nE "${pat_lt}|${pat_gt}|${pat_amp}" "$tmp" >/dev/null 2>&1; then
            echo "::group::HTML entity matches (non-comment lines)"
            grep -nE "${pat_lt}|${pat_gt}|${pat_amp}" "$tmp" || true
            echo "::endgroup::"
            echo "::error ::Found HTML entities (<, >, &) in .github/workflows (non-comment lines). Paste YAML as plain text."
            rm -f "$tmp"
            exit 1
          fi
          rm -f "$tmp"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # Guard: backticks in Python sources
      - name: Guard - stray Markdown backticks in Python files
        run: |
          if grep -RIn --include="*.py" -E '```|^`$' scripts; then
            echo "::error ::Markdown code fences/backticks found inside scripts/*.py"
            exit 1
          fi

      # Guard: HTML-encoded arrows in Python sources (pattern built at runtime)
      - name: Guard - HTML-encoded arrows in Python files
        run: |
          x='-'; y='&'; z='gt;'; pat="${x}${y}${z}"      # "->"
