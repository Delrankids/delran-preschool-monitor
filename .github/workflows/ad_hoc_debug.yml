name: "Delran Preschool Monitor (Ad-hoc Debug)"

on:
  workflow_dispatch:
    inputs:
      send_test:
        description: "Send a one-time test email first"
        required: false
        type: boolean
        default: false
      force_full_rescan:
        description: "Force full rescan (ignore state.json)"
        required: false
        type: boolean
        default: true
      debug_save_html:
        description: "Save fetched HTML in .debug/"
        required: false
        type: boolean
        default: true
      year:
        description: "Limit to a single year (e.g., 2023). Leave blank for all."
        required: false
        type: string
        default: ""
      max_boarddocs_files:
        description: "Cap BoardDocs discovery (recommend 200)"
        required: false
        type: number
        default: 200
      doc_delay_seconds:
        description: "Delay between document fetches"
        required: false
        type: string
        default: "1.5"

permissions:
  contents: write

jobs:
  debug:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Guard: build patterns at runtime so we don't embed < > & in this YAML
      - name: Guard - workflows must not contain HTML entities
        run: |
          set -e
          a='&'; b='lt;';  pat_lt="${a}${b}"
          b='gt;';         pat_gt="${a}${b}"
          b='amp;';        pat_amp="${a}${b}"
          tmp="$(mktemp)"
          (cat .github/workflows/*.yml 2>/dev/null || true) | awk '!/^[[:space:]]*#/' > "$tmp"
          # Debug (optional): uncomment to see exact matches
          # echo "::group::Raw grep output (if any)"; grep -nE "${pat_lt}|${pat_gt}|${pat_amp}" "$tmp" || true; echo "::endgroup::"
          if grep -nE "${pat_lt}|${pat_gt}|${pat_amp}" "$tmp" >/dev/null 2>&1; then
            echo "::group::HTML entity matches (non-comment lines)"
